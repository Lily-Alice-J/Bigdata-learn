Sqoop导数至Oracle踩坑记录

业务场景简介：
   客户方为Oracle数仓，需通过Sqoop建立大数据数据集市与传统数仓的传输通道

踩坑记录如下：
<1>Sqoop方面：
1.须在Sqoop /lib目录下存放RDMS驱动包，否则会报无法连接错误
2.在导出数据前可使用sqoop命令进行连接测试
   2.1 sqoop测试连接命令：sqoop list-tables --connect jdbc:oracle:thin:@ip:1521:sid --username ***--password ****
         需注意：Oracle共提供三种JDBC连接方式如下：
                       格式一：jdbc:oracle:thin:@//<host>:<port>/<service_name>  
                       格式二：jdbc:oracle:thin:@<host>:<port>:<SID> 
                       格式三：jdbc:oracle:thin:@<TNSName>
3.需清楚Hive底层存储格式 ORC/TextFile
   3.1 查询命令如下：hadoop fs -cat /user/hive/warehouse/wcl_dwh.db/dws_card_mpur_b_d/000000_0 | head -n 10 | cat -A
4.导数脚本如下：
    4.1 textfile全量版 分区推送export-dir指定相应文件即可；增量导数可见此链接: https://blog.csdn.net/helloxiaozhe/article/details/100176862
        sqoop export \
        --connect jdbc:oracle:thin:@ip:1521:sid\
        --username ***\
        --password ***\
        --export-dir /user/hive/warehouse/wcl_dwh.db/dws_card_mpur_b_d \
        --table DWS_CARD_MPUR_B_D \
        --input-null-string '\\N' \
        --input-null-non-string '\\N' \
        --input-fields-terminated-by '\001' \
        --lines-terminated-by '\n'
    4.2 orc全量版 增量导数可见此链接: https://www.cnblogs.com/lenmom/p/11281536.html
        sqoop export \
        --connect jdbc:oracle:thin:@ip:1521:sid\
        --username ***\
        --password ***\
        --table DWS_CARD_MPUR_B_D \
        --hcatalog-database wcl_dwh \
        --hcatalog-table dws_card_mpur_b_d \

<2> Oracle方面： 
   1. Oracle的服务名(ServiceName)查询
       show parameter service_name;
   2. Oracle的SID查询命令：
       select instance_name from v$instance;
   3. 查看Oracle版本
       select version from v$instance;

<3>优化方面
   1.Oracle并发写入如何加快同步速度？
      添加以下参数 --batch \
                           --Dsqoop.export.records.per.statement=10 \    --批量提交，每隔10条提交一次
   2.如何容错（失败重试）？
      添加以下参数  --staging-table <table-name> \
      由于Sqoop将导出过程切分成了多个，那么就会有可能某个导出任务失败而导致只有部分数据提交到了导出数据库中。当失败job重试时，就有可能会出现数据重复，或者导出数据            冲突等情况发生。这时可以指定一个--staging-table参数来避免这种情况的发生。导出的数据首先会缓存在该表中，最后等job执行成功后会将该表中的数据移动到最终目标表中。
   3.贷前宽表如何实现保留近三天数据-->shell脚本优化
   4.脚本如何更好的支持动态更改表结构-->shell脚本优化
      脚本如下:
            #!/bin/bash
            UN="system"
            PW="m89kPoF4"
            WH="orl11g"
            tableName=$1  #表名
            PT=`date -d "${4} +1 day " +%Y%m%d`  #分区值
            sqlplus ${UN}/${PW}@${WH}<<EOF
            alter table ${tableName}  add  partition part_${4}  values less than('${PT}');
            exit;
            EOF
            echo "${PT}"
            #传递表名,主键,分区字段,分区值
            tableName=$1
            sqoop export \
            --connect jdbc:oracle:thin:@172.19.53.145:1521:orl11g \
            --username system \
            --password m89kPoF4 \
            --table ${tableName^^} \
            --hcatalog-database wcl_dwh \
            --hcatalog-table ${tableName^^}  \
            --hcatalog-partition-keys ${3}  \
            --hcatalog-partition-values ${4} \
            --update-key ${2^^} \
            --update-mode allowinsert

附：
    通过YARN命令查看Job日志
    yarn logs -applicationId application_1592932322109_5986
